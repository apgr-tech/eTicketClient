<!--TODO habilitar login con otros proveedores -->
<!--TODO validar Form-->
<!--TODO enviar Form-->
<!--TODO Olvidé contraseña-->
<!--TODO Redireccionar si login exitoso-->
<Modal id="login" type="card" title="Iniciar Sesión" ref:modalComponent>
    <div slot="content">
        <form on:submit="login()">
            <div class="field">
                <label class="label">Email</label>
                <div class="control has-icons-left has-icons-right">
                    <input class='input {{error ? "is-danger" : ""}}' type="email" placeholder="Email" autocomplete="email" bind:value=email ref:emailInput required>
                    <span class="icon is-small is-left">
                        <i class="fas fa-envelope"></i>
                    </span>
                    <!-- TODO solo se debe mostrar si no pasa validacion -->
                    {{#if (!email && error) || error}}
                    <span class="icon is-small is-right">
                        <i class="fas fa-exclamation-triangle"></i>
                    </span>
                    {{/if}}
                </div>
            </div>
            <div class="field">
                <label class="label">Contraseña</label>
                <div class="control has-icons-left has-icons-right">
                    <input class='input {{error ? "is-danger" : ""}}' type="password" placeholder="Contraseña" autocomplete="current-password" bind:value=pass ref:passInput required>
                    <span class="icon is-small is-left">
                        <i class="fas fa-key"></i>
                    </span>
                    <!-- TODO solo se debe mostrar si no pasa validacion -->
                    {{#if (!pass && error) || error}}
                    <span class="icon is-small is-right">
                        <i class="fas fa-exclamation-triangle"></i>
                    </span>
                    {{/if}}
                </div>
            </div>
            {{#if error}}
            <p class="help is-danger">Usuario o Contraseña Invalidos</p>
            {{/if}}
        </form>

    </div>
    <div slot="footer">
        <button ref:submitButton class="button is-primary" disabled='{{!email || !pass}}' on:click="login()">Ingresar</button>
    </div>
</Modal>

<style type="text/scss">
    @import "_components/loginform/loginform";
</style>
<script>
    import { api } from '../../_scripts/api';
    import { goto } from 'sapper/runtime';
    //Icons for inputs
    import fontawesome from '@fortawesome/fontawesome';
    import faKey from '@fortawesome/fontawesome-free-solid/faKey';
    import faEnvelope from '@fortawesome/fontawesome-free-solid/faEnvelope';
    import faExclamationTriangle from '@fortawesome/fontawesome-free-solid/faExclamationTriangle';
    import Modal from '../modal/Modal.html';
    fontawesome.library.add(faKey);
    fontawesome.library.add(faEnvelope);
    fontawesome.library.add(faExclamationTriangle);
    export default {
        oncreate() {
            this.on('openModal',() => this.refs.modalComponent.fire('toggle'));
            this.on('logout', () => this.logout())
         },
        data() {
            return {
                email: '',
                pass: '',
                error: ''
            };
        },
        components: {
            Modal
        },
        methods: {
            login() {
                const url = '/Users/login';
                const emailInput = this.refs.emailInput;
                const passInput = this.refs.passInput;
                const submitButton = this.refs.submitButton;
                const email = this.get('email');
                const pass = this.get('pass');

                //Limpiar Alertas
                this.set({error: ''});
                emailInput.classList.remove('is-danger');
                passInput.classList.remove('is-danger');
                submitButton.classList.add('is-loading');

                //Enviar el query
                api.post(
                    url,
                    email.indexOf('@') > 0 ? {email:email,password: pass} : {username:email,password: pass})
                    .then(response => {
                        //Limpiar Alertas
                        this.set({error: ''});
                        submitButton.classList.remove('is-loading');
                        //Cerrar Modal
                        this.refs.modalComponent.fire('toggle');
                        //guardar la sesion
                        this.set({token: response.data.id});
                        window.sessionStorage.token = response.data.id;
                        //TODO Modificar el Index
                        goto('/');
                    })
                    .catch(error => {
                        submitButton.classList.remove('is-loading');
                        this.set({error: error});
                    });
            },
            logout(){
                this.set({token: false});
                window.sessionStorage.removeItem('token');
                goto('/')
            }
        }
    }

</script>
